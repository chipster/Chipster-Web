<div class="container-fluid">
  <h3 class="mt-4 mb-3">Sessions</h3>

  <div class="row">

    <div class="col">

      <!-- <div class="lighter">
        <p>Get started by creating a new session or play around with the example sessions. To open a session, click on the
          session name.</p>
      </div> -->

      <div class="mt-2 mb-4">
        <button class="btn btn-sm btn-info mr-2" (click)="createSession()">
          <span class="fa fa-plus" aria-hidden="true"></span>
          New session
        </button>
        <ch-open-session-file (done)="sessionsUploaded($event)"></ch-open-session-file>
      </div>

      <div class="session-list">
        <div *ngFor="let sharedByUsername of sessionsByUserKeys">

          <h5>{{getSharedByTitlePart(sharedByUsername)}}
            <i>{{getSharedByUsernamePart(sharedByUsername)}}</i>

            <!-- <span *ngIf="sharedByUsername === null" class="float-right">
              <button class="btn btn-sm btn-info mr-2" (click)="createSession()">
                <span class="fa fa-plus" aria-hidden="true"></span>
                New session
              </button>
              <ch-open-session-file (done)="sessionsUploaded($event)"></ch-open-session-file>
            </span> -->
          </h5>

          <!-- <div *ngIf="sharedByUsername === null" class="mt-2 mb-4">
            <button class="btn btn-sm btn-info mr-2" (click)="createSession()">
              <span class="fa fa-plus" aria-hidden="true"></span>
              New session
            </button>
            <ch-open-session-file (done)="sessionsUploaded($event)"></ch-open-session-file>
          </div> -->


          <table *ngIf="noPersonalSessions && sharedByUsername === null" class="table table-sm">
            <tbody>
              <tr class="session-list-item">
                <td style="font-size: smaller"><i>No sessions yet.</i></td>
              </tr>
            </tbody>
          </table>

          <table class="table table-sm" [ngClass]="{'table-hover': !selectionDisabled}">
            <tbody>
              <tr *ngFor="let session of sessionsByUser.get(sharedByUsername)" (mouseover)="selectSession(session)" (mouseout)="selectSession(null)"
                (click)="onSessionClick(session)" [ngClass]="{'selected-session': isSessionSelected(session)}" class="session-list-item"
                title="Open session">
                <td>

                  <!-- <button class="btn btn-sm btn-outline-dark btn-no-border show-on-row-hover" title="">
                    <span class="fa fa-arrow-circle-o-right"></span>
                  </button> -->

                  <span>{{session.name}}

                    <!-- delete button -->
                    <span *ngIf="sessionDataService.hasPersonalRule(session.rules)">
                      <button *ngIf="!deletingSessions.has(session)" [ngClass]="{'visible-button': isSessionSelected(session)}" [ngClass]="{'show-on-row-hover': !selectionDisabled}"
                        class="btn btn-sm btn-outline-dark btn-no-border hidden float-right" (click)="deleteSession(session); $event.stopImmediatePropagation(); "
                        title="Delete">
                        <span class="fa fa-times "></span>
                      </button>
                      <span class="pull-right " *ngIf="deletingSessions.has(session) ">Deleting...</span>
                    </span>

                    <!-- context menu button -->
                    <div ngbDropdown #sessionDropdown="ngbDropdown" class="float-right d-inline-block" placement="bottom-right" (openChange)="sessionMenuOpenChange($event)">
                      <button (click)="$event.stopPropagation();" [ngClass]="{'visible-button': isSessionSelected(session)}" [ngClass]="{'show-on-row-hover': !selectionDisabled}"
                        class="btn btn-sm btn-outline-dark btn-no-border hidden float-right" id="sessionDropdown" title="Actions"
                        ngbDropdownToggle>
                        <i class="fa fa-ellipsis-h" aria-hidden="true"></i></button>
                      <div ngbDropdownMenu aria-labelledby="sessionDropdown" class="dropdown-menu-left">
                        <button [disabled]="!sessionDataService.hasPersonalRule(session.rules)" class="dropdown-item" (click)="sessionDropdown.toggle();rename(session)">Rename&hellip;</button>
                        <button class="dropdown-item" (click)="sessionDropdown.toggle();notes(session)">{{getNotesButtonText(session)}}&hellip;</button>
                        <button class="dropdown-item" (click)="sessionDropdown.toggle();duplicate(session)">Duplicate&hellip;</button>
                        <button [disabled]="!sessionDataService.hasPersonalRule(session.rules)" class="dropdown-item" (click)="sessionDropdown.toggle();share(session)">Share&hellip;</button>
                        <button class="dropdown-item" (click)="sessionDropdown.toggle();download(session)">Download</button>
                      </div>
                    </div>
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
          <br>
        </div>
      </div>
    </div>

    <div class="col">

      <div id="workflow-dataset-panel" class="lighter">
        <p>To open a session, click on the session name.
        </p>

        <p>Sessions keep your analysis projects organized. They combine together your raw data files and analysis results
          and also keep track of the analysis history. This makes it easy to understand afterwards how the data was analyzed.
        </p>

        <p>Creating a new session for each experiment is usually a good approach.</p>

        <p>Sessions are stored on the server, but you can download session to a local zip file to have a backup copy of your
          data or transfer data between different Chipster servers.</p>
      </div>


      <div id="session-preview" style="position: relative">
        <div id="preview-container" *ngIf="selectedSession ">

          <h5> {{selectedSession.name}} <span style="font-size: 80%" class="lighter float-right"><i>preview</i></span></h5>

          <div class="workflow-preview-panel ">

            <p *ngIf="workflowPreviewLoading ">
              <br>
              <i class="fa fa-circle-o-notch fa-spin " style="font-size:22px "></i> Loading preview...
            </p>

            <p *ngIf="workflowPreviewFailed ">
              <i>Loading preview failed</i>
            </p>

            <div class="workflow-graph-panel " *ngIf="sessionData && sessionData.datasetsMap && sessionData.jobsMap ">
              <ch-workflow-graph [datasetsMap]="sessionData.datasetsMap " [jobsMap]="sessionData.jobsMap " [modulesMap]="sessionData.modulesMap "
                [defaultScale]="0.5 " [enabled]="false "></ch-workflow-graph>
            </div>
          </div>

          <div>
            <!-- Create new element for each paragraph to preserve new line characters -->
            <p *ngFor="let line of selectedSession.notes?.split( '\n') ">
              {{line}}
            </p>
          </div>

        </div>
      </div>

    </div> <!-- col-->
  </div> <!-- row-->
</div>